<!doctype html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Albion Blackmarket Reader – Dashboard</title>
  <meta name="description" content="Albion Blackmarket Reader Dashboard – Profitable items, city comparison, silver filters and Black Market insights." />
  <link rel="icon" type="image/x-icon" href="picture/logoicon.ico" />
  <link rel="stylesheet" href="styles.css" />
</head>
<body>

  <div class="static-bg" id="staticBg"></div>

  <img src="picture/testo ohne background.png" alt="Logo" class="logo-fixed" onclick="window.location.href='index.html'" />
  <button class="mobile-back" onclick="window.location.href='index.html'">← Back</button>

  <div class="account-wrap">
    <button id="accountBtn" class="account-btn" aria-label="Account">
      <img id="avatarIcon" src="picture/avatars/default.png" alt="Avatar" />
    </button>
  </div>

  <div id="toast" class="toast" style="display:none;"></div>

  <div id="confirmModal" class="modal-overlay" style="display:none;">
    <div class="modal-card">
      <h3>Check your email</h3>
      <p>We sent you a confirmation email. Please verify it before logging in.</p>
      <button id="confirmClose" class="cta">OK</button>
    </div>
  </div>

  <div id="accountPanel" class="account-panel">
    <div class="account-header">
      <img id="profileAvatar" class="avatar-big" src="picture/avatars/default.png" alt="Avatar" />
      <div class="user-info">
        <span class="email" id="accountEmail">-</span>
        <span class="status">Logged in</span>
      </div>
      <button id="accountClose" class="close-btn">✕</button>
    </div>

    <div class="avatar-select">
      <h4>Select profile avatar</h4>
      <div class="avatar-grid">
        <img src="picture/Bridgewatch.png" data-avatar="picture/Bridgewatch.png" alt="Bridgewatch">
        <img src="picture/Carleon.png" data-avatar="picture/Carleon.png" alt="Caerleon">
        <img src="picture/Martlockwappen.png" data-avatar="picture/Martlockwappen.png" alt="Martlock">
        <img src="picture/Lymhurstwappen.png" data-avatar="picture/Lymhurstwappen.png" alt="Lymhurst">
        <img src="picture/Thefortwappen.png" data-avatar="picture/Thefortwappen.png" alt="Thetford">
      </div>
    </div>

    <button id="resetPw" class="btn primary">🔒 Change password</button>
    <button id="logout" class="btn danger">Logout</button>

    <div class="account-help">
      <span>Need help?</span>
      <a href="mailto:blackmarketreader@gmail.com">blackmarketreader@gmail.com</a>
    </div>
  </div>

  <div id="loadingOverlay" class="loading-overlay">
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading data...</div>
  </div>

  <div id="authModal" class="auth-modal" style="display:none;">
    <div class="auth-card">
      <div class="auth-header">
        <img src="picture/testo ohne background.png" class="auth-logo" alt="Logo">
        <h2>RomulusKings Market Reader</h2>
        <p>Black Market Profit Tool</p>
      </div>

      <div class="auth-tabs">
        <button id="tabLogin" class="tab active">Login</button>
        <button id="tabRegister" class="tab">Register</button>
      </div>

      <div id="loginForm">
        <input id="authEmail" type="email" placeholder="Email" />
        <input id="authPassword" type="password" placeholder="Password" />
        <div class="auth-actions">
          <button id="btnLogin" class="cta">Login</button>
          <button id="btnGoogle" class="ghost btn-google">
            <img src="picture/Googleicon.png" alt="Google Login">
          </button>
        </div>
        <p class="auth-hint">📩 Please confirm your email before logging in.</p>
      </div>

      <div id="registerForm" style="display:none;">
        <input id="regName" type="text" placeholder="Display Name" />
        <input id="regEmail" type="email" placeholder="Email" />
        <input id="regPassword" type="password" placeholder="Password" />
        <div class="auth-actions">
          <button id="btnRegister" class="cta">Register</button>
        </div>
        <p class="auth-hint">📩 You will receive a confirmation email after registration.</p>
      </div>

      <div id="authError" class="auth-error"></div>

      <div class="auth-footer">
        <a href="mailto:blackmarketreader@gmail.com">Support: blackmarketreader@gmail.com</a>
      </div>

      <div class="auth-trust">🔒 Powered by Supabase · Secure Authentication</div>
    </div>
  </div>

  <div id="app" class="page" style="display:none;">
    <div class="hero">
      <div>
        <h1>RomulusKings Market Reader</h1>
        <p>>= 30% Profit · 14-Day Range · Live Black Market Data</p>
      </div>
      <div class="hero-cta">
        <div class="badge" id="lastUpdated">Last update: --:-- --.--.----</div>
        <div class="pill-row">
          <span class="pill" id="dealsCount">Deals: 0</span>
        </div>
      </div>
    </div>

    <div class="layout">
      <div class="main-col">
        <div class="filters">
          Profit ≥ <input id="minProfit" type="number" value="0" /> %
          <button id="applyFilter">Apply filter</button>
          <button id="filterSilver">Sort by silver</button>
          <button id="clearSilver" style="display:none;">Reset</button>
        </div>

        <div id="cards" class="grid"></div>
      </div>

      <aside class="aside">
        <div class="city-panel">
          <img id="cityCrest" class="city-crest-img" src="picture/Carleon.png" />
          <div class="city-panel-body">
            <span class="city-panel-title">City</span>
            <span class="city-panel-name" id="cityName">All Cities</span>
            <select id="citySelect" class="city-select">
              <option value="ALL">All Cities</option>
              <option value="Lymhurst">Lymhurst</option>
              <option value="Martlock">Martlock</option>
              <option value="Fort Sterling">Fort Sterling</option>
              <option value="Thetford">Thetford</option>
              <option value="Bridgewatch">Bridgewatch</option>
              <option value="Caerleon">Caerleon</option>
            </select>
          </div>
        </div>
      </aside>
    </div>
  </div>


  <script src="env.js"></script>
  <script type="module">
    import { createClient } from 'https://cdn.jsdelivr.net/npm/@supabase/supabase-js/+esm';

    const SUPABASE_URL = window.env?.SUPABASE_URL;
    const SUPABASE_ANON_KEY = window.env?.SUPABASE_ANON_KEY;

    if (!SUPABASE_URL || !SUPABASE_ANON_KEY) {
      alert("Supabase configuration missing. Please set SUPABASE_URL and SUPABASE_ANON_KEY in env.js.");
    }

    const supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

    const loadingOverlay = document.getElementById('loadingOverlay');
    const app = document.getElementById('app');
    const cardsEl = document.getElementById('cards');
    const minProfitEl = document.getElementById('minProfit');
    const applyFilterEl = document.getElementById('applyFilter');
    const filterSilverEl = document.getElementById('filterSilver');
    const clearSilverEl = document.getElementById('clearSilver');
    const lastUpdatedEl = document.getElementById('lastUpdated');
    const dealsCountEl = document.getElementById('dealsCount');
    const citySelectEl = document.getElementById('citySelect');
    const cityNameEl = document.getElementById('cityName');
    const cityCrestEl = document.getElementById('cityCrest');
    const staticBg = document.getElementById('staticBg');

    const authModal = document.getElementById('authModal');
    const authEmail = document.getElementById('authEmail');
    const authPassword = document.getElementById('authPassword');
    const regName = document.getElementById('regName');
    const regEmail = document.getElementById('regEmail');
    const regPassword = document.getElementById('regPassword');
    const loginForm = document.getElementById('loginForm');
    const registerForm = document.getElementById('registerForm');
    const tabLogin = document.getElementById('tabLogin');
    const tabRegister = document.getElementById('tabRegister');
    const authError = document.getElementById('authError');
    const btnLogin = document.getElementById('btnLogin');
    const btnRegister = document.getElementById('btnRegister');
    const btnGoogle = document.getElementById('btnGoogle');
    const accountBtn = document.getElementById('accountBtn');
    const accountPanel = document.getElementById('accountPanel');
    const accountClose = document.getElementById('accountClose');
    const accountEmail = document.getElementById('accountEmail');
    const avatarIcon = document.getElementById('avatarIcon');
    const profileAvatar = document.getElementById('profileAvatar');
    const resetPw = document.getElementById('resetPw');
    const logout = document.getElementById('logout');
    const confirmModal = document.getElementById('confirmModal');
    const confirmClose = document.getElementById('confirmClose');

    const crestMap = {
      "ALL": "picture/Carleon.png",
      "Lymhurst": "picture/Lymhurstwappen.png",
      "Martlock": "picture/Martlockwappen.png",
      "Fort Sterling": "picture/Fortsterlingwappen.png",
      "Thetford": "picture/Thefortwappen.png",
      "Bridgewatch": "picture/Bridgewatch.png",
      "Caerleon": "picture/Carleon.png"
    };

    const nameMap = {
      "OFF_SHIELD": "Beginner's Shield",
      "OFF_TOWERSHIELD_UNDEAD": "Sarcophagus",
      "OFF_SHIELD_HELL": "Caitiff Shield",
      "OFF_SPIKEDSHIELD_MORGANA": "Facebreaker",
      "OFF_SHIELD_AVALON": "Astral Aegis",
      "OFF_SHIELD_CRYSTAL": "Unbreakable Ward",
      "OFF_BOOK": "Tome of Spells",
      "OFF_ORB_MORGANA": "Eye of Secrets",
      "OFF_DEMONSKULL_HELL": "Muisak",
      "OFF_TOTEM_KEEPER": "Taproot",
      "OFF_CENSER_AVALON": "Celestial Censer",
      "OFF_TOME_CRYSTAL": "Timelocked Grimoire",
      "OFF_TORCH": "Torch",
      "OFF_HORN_KEEPER": "Mistcaller",
      "OFF_TALISMAN_AVALON": "Sacred Scepter",
      "OFF_LAMP_UNDEAD": "Cryptcandle",
      "OFF_JESTERCANE_HELL": "Leering Cane",
      "OFF_TORCH_CRYSTAL": "Blueflame Torch",
      "HEAD_PLATE_SET1": "Soldier Helmet",
      "ARMOR_PLATE_SET1": "Soldier Armor",
      "SHOES_PLATE_SET1": "Soldier Boots",
      "HEAD_PLATE_SET2": "Knight Helmet",
      "ARMOR_PLATE_SET2": "Knight Armor",
      "SHOES_PLATE_SET2": "Knight Boots",
      "HEAD_PLATE_SET3": "Guardian Helmet",
      "ARMOR_PLATE_SET3": "Guardian Armor",
      "SHOES_PLATE_SET3": "Guardian Boots",
      "HEAD_PLATE_UNDEAD": "Graveguard Helmet",
      "ARMOR_PLATE_UNDEAD": "Graveguard Armor",
      "SHOES_PLATE_UNDEAD": "Graveguard Boots",
      "HEAD_PLATE_HELL": "Demon Helmet",
      "ARMOR_PLATE_HELL": "Demon Armor",
      "SHOES_PLATE_HELL": "Demon Boots",
      "HEAD_PLATE_KEEPER": "Judicator Helmet",
      "ARMOR_PLATE_KEEPER": "Judicator Armor",
      "SHOES_PLATE_KEEPER": "Judicator Boots",
      "HEAD_PLATE_FEY": "Duskweaver Helmet",
      "ARMOR_PLATE_FEY": "Duskweaver Armor",
      "SHOES_PLATE_FEY": "Duskweaver Boots",
      "HEAD_PLATE_AVALON": "Helmet of Valor",
      "ARMOR_PLATE_AVALON": "Armor of Valor",
      "SHOES_PLATE_AVALON": "Boots of Valor",
      "HEAD_LEATHER_SET1": "Beginner's Mercenary Hood",
      "ARMOR_LEATHER_SET1": "Beginner's Mercenary Jacket",
      "SHOES_LEATHER_SET1": "Beginner's Mercenary Shoes",
      "HEAD_LEATHER_SET2": "Hunter Hood",
      "ARMOR_LEATHER_SET2": "Hunter Jacket",
      "SHOES_LEATHER_SET2": "Hunter Shoes",
      "HEAD_LEATHER_SET3": "Assassin Hood",
      "ARMOR_LEATHER_SET3": "Assassin Jacket",
      "SHOES_LEATHER_SET3": "Assassin Shoes",
      "HEAD_LEATHER_MORGANA": "Stalker Hood",
      "ARMOR_LEATHER_MORGANA": "Stalker Jacket",
      "SHOES_LEATHER_MORGANA": "Stalker Shoes",
      "HEAD_LEATHER_HELL": "Hellion Hood",
      "ARMOR_LEATHER_HELL": "Hellion Jacket",
      "SHOES_LEATHER_HELL": "Hellion Shoes",
      "HEAD_LEATHER_UNDEAD": "Specter Hood",
      "ARMOR_LEATHER_UNDEAD": "Specter Jacket",
      "SHOES_LEATHER_UNDEAD": "Specter Shoes",
      "HEAD_LEATHER_FEY": "Mistwalker Hood",
      "ARMOR_LEATHER_FEY": "Mistwalker Jacket",
      "SHOES_LEATHER_FEY": "Mistwalker Shoes",
      "HEAD_LEATHER_AVALON": "Hood of Tenacity",
      "ARMOR_LEATHER_AVALON": "Jacket of Tenacity",
      "SHOES_LEATHER_AVALON": "Shoes of Tenacity",
      "HEAD_CLOTH_SET1": "Scholar Cowl",
      "ARMOR_CLOTH_SET1": "Scholar Robe",
      "SHOES_CLOTH_SET1": "Scholar Sandals",
      "HEAD_CLOTH_SET2": "Cleric Cowl",
      "ARMOR_CLOTH_SET2": "Cleric Robe",
      "SHOES_CLOTH_SET2": "Cleric Sandals",
      "HEAD_CLOTH_SET3": "Mage Cowl",
      "ARMOR_CLOTH_SET3": "Mage Robe",
      "SHOES_CLOTH_SET3": "Mage Sandals",
      "HEAD_CLOTH_KEEPER": "Druid Cowl",
      "ARMOR_CLOTH_KEEPER": "Druid Robe",
      "SHOES_CLOTH_KEEPER": "Druid Sandals",
      "HEAD_CLOTH_HELL": "Fiend Cowl",
      "ARMOR_CLOTH_HELL": "Fiend Robe",
      "SHOES_CLOTH_HELL": "Fiend Sandals",
      "HEAD_CLOTH_MORGANA": "Cultist Cowl",
      "ARMOR_CLOTH_MORGANA": "Cultist Robe",
      "SHOES_CLOTH_MORGANA": "Cultist Sandals",
      "HEAD_CLOTH_FEY": "Feyscale Hat",
      "ARMOR_CLOTH_FEY": "Feyscale Robe",
      "SHOES_CLOTH_FEY": "Feyscale Sandals",
      "HEAD_CLOTH_AVALON": "Cowl of Purity",
      "ARMOR_CLOTH_AVALON": "Robe of Purity",
      "SHOES_CLOTH_AVALON": "Sandals of Purity",
      "HEAD_CLOTH_ROYAL": "Royal Cowl",
      "ARMOR_CLOTH_ROYAL": "Royal Robe",
      "SHOES_CLOTH_ROYAL": "Royal Sandals",
      "HEAD_LEATHER_ROYAL": "Royal Hood",
      "ARMOR_LEATHER_ROYAL": "Royal Jacket",
      "SHOES_LEATHER_ROYAL": "Royal Shoes",
      "HEAD_PLATE_ROYAL": "Royal Helmet",
      "ARMOR_PLATE_ROYAL": "Royal Armor",
      "SHOES_PLATE_ROYAL": "Royal Boots",
      "HEAD_GATHERER_FIBER": "Harvester Cap",
      "ARMOR_GATHERER_FIBER": "Harvester Garb",
      "SHOES_GATHERER_FIBER": "Harvester Workboots",
      "HEAD_GATHERER_HIDE": "Skinner Cap",
      "ARMOR_GATHERER_HIDE": "Skinner Garb",
      "SHOES_GATHERER_HIDE": "Skinner Workboots",
      "HEAD_GATHERER_ORE": "Miner Cap",
      "ARMOR_GATHERER_ORE": "Miner Garb",
      "SHOES_GATHERER_ORE": "Miner Workboots",
      "HEAD_GATHERER_ROCK": "Quarrier Cap",
      "ARMOR_GATHERER_ROCK": "Quarrier Garb",
      "SHOES_GATHERER_ROCK": "Quarrier Workboots",
      "HEAD_GATHERER_WOOD": "Lumberjack Cap",
      "ARMOR_GATHERER_WOOD": "Lumberjack Garb",
      "SHOES_GATHERER_WOOD": "Lumberjack Workboots",
      "HEAD_GATHERER_FISH": "Fisherman Cap",
      "ARMOR_GATHERER_FISH": "Fisherman Garb",
      "SHOES_GATHERER_FISH": "Fisherman Workboots",
      "2H_BOW": "Bow",
      "2H_WARBOW": "Warbow",
      "2H_LONGBOW": "Longbow",
      "2H_LONGBOW_UNDEAD": "Whispering Bow",
      "2H_BOW_HELL": "Wailing Bow",
      "2H_BOW_KEEPER": "Bow of Badon",
      "2H_BOW_AVALON": "Mistpiercer",
      "2H_BOW_CRYSTAL": "Skystrider Bow",
      "2H_CROSSBOW": "Crossbow",
      "2H_CROSSBOWLARGE": "Heavy Crossbow",
      "MAIN_1HCROSSBOW": "Light Crossbow",
      "2H_REPEATINGCROSSBOW_UNDEAD": "Weeping Repeater",
      "2H_DUALCROSSBOW_HELL": "Boltcasters",
      "2H_CROSSBOWLARGE_MORGANA": "Siegebow",
      "2H_CROSSBOW_CANNON_AVALON": "Energy Shaper",
      "2H_DUALCROSSBOW_CRYSTAL": "Arclight Blasters",
      "MAIN_CURSEDSTAFF": "Cursed Staff",
      "2H_CURSEDSTAFF": "Great Cursed Staff",
      "2H_DEMONICSTAFF": "Demonic Staff",
      "MAIN_CURSEDSTAFF_UNDEAD": "Lifecurse Staff",
      "2H_SKULLORB_HELL": "Cursed Skull",
      "2H_CURSEDSTAFF_MORGANA": "Damnation Staff",
      "MAIN_CURSEDSTAFF_AVALON": "Shadowcaller",
      "MAIN_CURSEDSTAFF_CRYSTAL": "Rotcaller Staff",
      "MAIN_FIRESTAFF": "Fire Staff",
      "2H_FIRESTAFF": "Great Fire Staff",
      "2H_INFERNOSTAFF": "Infernal Staff",
      "MAIN_FIRESTAFF_KEEPER": "Wildfire Staff",
      "2H_FIRESTAFF_HELL": "Brimstone Staff",
      "2H_INFERNOSTAFF_MORGANA": "Blazing Staff",
      "2H_FIRE_RINGPAIR_AVALON": "Dawnsong",
      "MAIN_FIRESTAFF_CRYSTAL": "Flamewalker Staff",
      "MAIN_FROSTSTAFF": "Frost Staff",
      "2H_FROSTSTAFF": "Great Frost Staff",
      "2H_GLACIALSTAFF": "Glacial Staff",
      "MAIN_FROSTSTAFF_KEEPER": "Hoarfrost Staff",
      "2H_ICEGAUNTLETS_HELL": "Icicle Staff",
      "2H_ICECRYSTAL_UNDEAD": "Permafrost Prism",
      "MAIN_FROSTSTAFF_AVALON": "Chillhowl",
      "2H_FROSTSTAFF_CRYSTAL": "Arctic Staff",
      "MAIN_ARCANESTAFF": "Arcane Staff",
      "2H_ARCANESTAFF": "Great Arcane Staff",
      "2H_ENIGMATICSTAFF": "Enigmatic Staff",
      "MAIN_ARCANESTAFF_UNDEAD": "Witchwork Staff",
      "2H_ARCANESTAFF_HELL": "Occult Staff",
      "2H_ENIGMATICORB_MORGANA": "Malevolent Locus",
      "2H_ARCANE_RINGPAIR_AVALON": "Evensong",
      "2H_ARCANESTAFF_CRYSTAL": "Astral Staff",
      "MAIN_HOLYSTAFF": "Holy Staff",
      "2H_HOLYSTAFF": "Great Holy Staff",
      "2H_DIVINESTAFF": "Divine Staff",
      "MAIN_HOLYSTAFF_MORGANA": "Lifetouch Staff",
      "2H_HOLYSTAFF_HELL": "Fallen Staff",
      "2H_HOLYSTAFF_UNDEAD": "Redemption Staff",
      "MAIN_HOLYSTAFF_AVALON": "Hallowfall",
      "2H_HOLYSTAFF_CRYSTAL": "Exalted Staff",
      "MAIN_NATURESTAFF": "Nature Staff",
      "2H_NATURESTAFF": "Great Nature Staff",
      "2H_WILDSTAFF": "Wild Staff",
      "MAIN_NATURESTAFF_KEEPER": "Druidic Staff",
      "2H_NATURESTAFF_HELL": "Blight Staff",
      "2H_NATURESTAFF_KEEPER": "Rampant Staff",
      "MAIN_NATURESTAFF_AVALON": "Ironroot Staff",
      "MAIN_NATURESTAFF_CRYSTAL": "Forgebark Staff",
      "MAIN_DAGGER": "Dagger",
      "2H_DAGGERPAIR": "Dagger Pair",
      "2H_CLAWPAIR": "Claws",
      "MAIN_RAPIER_MORGANA": "Bloodletter",
      "MAIN_DAGGER_HELL": "Demonfang",
      "2H_IRONGAUNTLETS_HELL": "Black Hands",
      "2H_DUALSICKLE_UNDEAD": "Deathgivers",
      "2H_DAGGER_KATAR_AVALON": "Bridled Fury",
      "2H_DAGGERPAIR_CRYSTAL": "Twin Slayers",
      "MAIN_SPEAR": "Spear",
      "2H_SPEAR": "Pike",
      "2H_GLAIVE": "Glaive",
      "MAIN_SPEAR_KEEPER": "Heron Spear",
      "2H_HARPOON_HELL": "Spirithunter",
      "2H_TRIDENT_UNDEAD": "Trinity Spear",
      "MAIN_SPEAR_LANCE_AVALON": "Daybreaker",
      "2H_GLAIVE_CRYSTAL": "Rift Glaive",
      "MAIN_AXE": "Battleaxe",
      "2H_AXE": "Greataxe",
      "2H_HALBERD": "Halberd",
      "2H_HALBERD_MORGANA": "Carrioncaller",
      "2H_SCYTHE_HELL": "Infernal Scythe",
      "2H_DUALAXE_KEEPER": "Bear Paws",
      "2H_AXE_AVALON": "Realmbreaker",
      "2H_SCYTHE_CRYSTAL": "Crystal Reaper",
      "MAIN_SWORD": "Beginner's Broadsword",
      "2H_CLAYMORE": "Claymore",
      "2H_DUALSWORD": "Dual Swords",
      "MAIN_SCIMITAR_MORGANA": "Clarent Blade",
      "2H_CLEAVER_HELL": "Carving Sword",
      "2H_DUALSCIMITAR_UNDEAD": "Galatine Pair",
      "2H_CLAYMORE_AVALON": "Kingmaker",
      "MAIN_SWORD_CRYSTAL": "Infinity Blade",
      "2H_QUARTERSTAFF": "Quarterstaff",
      "2H_IRONCLADEDSTAFF": "Iron-clad Staff",
      "2H_DOUBLEBLADEDSTAFF": "Double Bladed Staff",
      "2H_COMBATSTAFF_MORGANA": "Black Monk Stave",
      "2H_TWINSCYTHE_HELL": "Soulscythe",
      "2H_ROCKSTAFF_KEEPER": "Staff of Balance",
      "2H_QUARTERSTAFF_AVALON": "Grailseeker",
      "2H_DOUBLEBLADEDSTAFF_CRYSTAL": "Phantom Twinblade",
      "MAIN_HAMMER": "Hammer",
      "2H_POLEHAMMER": "Polehammer",
      "2H_HAMMER": "Great Hammer",
      "2H_HAMMER_UNDEAD": "Tombhammer",
      "2H_DUALHAMMER_HELL": "Forge Hammers",
      "2H_RAM_KEEPER": "Grovekeeper",
      "2H_HAMMER_AVALON": "Hand of Justice",
      "2H_HAMMER_CRYSTAL": "Truebolt Hammer",
      "MAIN_MACE": "Mace",
      "2H_MACE": "Heavy Mace",
      "2H_FLAIL": "Morning Star",
      "MAIN_ROCKMACE_KEEPER": "Bedrock Mace",
      "MAIN_MACE_HELL": "Incubus Mace",
      "2H_MACE_MORGANA": "Camlann Mace",
      "2H_DUALMACE_AVALON": "Oathkeepers",
      "MAIN_MACE_CRYSTAL": "Dreadstorm Monarch",
      "2H_KNUCKLES_SET1": "Brawler Gloves",
      "2H_KNUCKLES_SET2": "Battle Bracers",
      "2H_KNUCKLES_SET3": "Spiked Gauntlets",
      "2H_KNUCKLES_KEEPER": "Ursine Maulers",
      "2H_KNUCKLES_HELL": "Hellfire Hands",
      "2H_KNUCKLES_MORGANA": "Ravenstrike Cestus",
      "2H_KNUCKLES_AVALON": "Fists of Avalon",
      "2H_KNUCKLES_CRYSTAL": "Forcepulse Bracers",
      "2H_SHAPESHIFTER_SET1": "Prowling Staff",
      "2H_SHAPESHIFTER_SET2": "Rootbound Staff",
      "2H_SHAPESHIFTER_SET3": "Primal Staff",
      "2H_SHAPESHIFTER_MORGANA": "Bloodmoon Staff",
      "2H_SHAPESHIFTER_HELL": "Hellspawn Staff",
      "2H_SHAPESHIFTER_KEEPER": "Earthrune Staff",
      "2H_SHAPESHIFTER_AVALON": "Lightcaller",
      "2H_SHAPESHIFTER_CRYSTAL": "Stillgaze Staff"
    };

    const bgMap = {
      "ALL": "radial-gradient(circle at 20% 30%, rgba(92,240,200,0.14), transparent 40%), radial-gradient(circle at 80% 20%, rgba(125,211,255,0.12), transparent 35%), radial-gradient(circle at 60% 80%, rgba(92,240,200,0.10), transparent 40%), linear-gradient(180deg, #0a0d14, #080b12)",
      "Lymhurst": "radial-gradient(circle at 20% 30%, rgba(92,240,200,0.18), transparent 40%), radial-gradient(circle at 80% 20%, rgba(92,240,200,0.10), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Martlock": "radial-gradient(circle at 20% 30%, rgba(94,199,255,0.18), transparent 40%), radial-gradient(circle at 80% 20%, rgba(118,187,255,0.12), transparent 35%), linear-gradient(180deg, #0b0f15, #0a0d14)",
      "Fort Sterling": "radial-gradient(circle at 20% 30%, rgba(255,255,255,0.16), transparent 42%), radial-gradient(circle at 75% 20%, rgba(180,180,180,0.08), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Thetford": "radial-gradient(circle at 20% 30%, rgba(158,117,255,0.16), transparent 42%), radial-gradient(circle at 75% 20%, rgba(118,87,255,0.10), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Bridgewatch": "radial-gradient(circle at 20% 30%, rgba(255,170,92,0.18), transparent 42%), radial-gradient(circle at 75% 20%, rgba(255,140,60,0.10), transparent 35%), linear-gradient(180deg, #0b0f15, #090c12)",
      "Caerleon": "radial-gradient(circle at 20% 30%, rgba(30,30,30,0.22), transparent 42%), radial-gradient(circle at 75% 20%, rgba(0,0,0,0.14), transparent 35%), linear-gradient(180deg, #0b0f15, #080b12)"
    };

    async function loadAvatar() {
      const { data } = await supabase.auth.getUser();
      if (!data?.user) return;
      const metaAvatar = data.user.user_metadata?.avatar || data.user.user_metadata?.avatar_url || data.user.user_metadata?.picture;
      const avatar = metaAvatar || "picture/Carleon.png";
      accountEmail.textContent = data.user.email || "-";
      avatarIcon.src = avatar;
      profileAvatar.src = avatar;
    }

    let allData = [];
    let minProfitFilter = 0;
    let sortBySilver = false;
    let cityFilter = "ALL";

    function setBg(city) {
      staticBg.style.background = bgMap[city] || bgMap.ALL;
    }

    function displayName(id) {
      const baseNoEnchant = id.split("@")[0];
      const parts = baseNoEnchant.split("_");
      if (parts.length < 2) return id;
      const tier = parts[0].replace("T", "");
      const enchantMatch = id.match(/@([0-4])/);
      const ench = enchantMatch ? "." + enchantMatch[1] : "";
      const key = parts.slice(1).join("_"); // ohne Tier
      const translated = nameMap[key] || key.replace(/_/g, " ");
      return `${tier}${ench}\u00A0\u00A0${translated}`;
    }

    function render() {
      cardsEl.innerHTML = "";
      const filtered = allData.filter(item =>
        item.profit >= minProfitFilter &&
        (cityFilter === "ALL" || item.city === cityFilter)
      );

      const list = sortBySilver
        ? [...filtered].sort((a, b) => (b.bm - b.lym) - (a.bm - a.lym))
        : filtered;

      dealsCountEl.textContent = `Deals: ${list.length}`;

      for (const item of list) {
        const profitText = sortBySilver
          ? `Profit: ${(item.bm - item.lym).toLocaleString('de-DE')} Silber`
          : `Profit: ${item.profit.toFixed(1)}%`;

        const enchantClass = item.id.includes("@1") ? "border-enchant-1"
          : item.id.includes("@2") ? "border-enchant-2"
          : item.id.includes("@3") ? "border-enchant-3"
          : item.id.includes("@4") ? "border-enchant-4"
          : "";

        const card = document.createElement("div");
        card.className = `card ${enchantClass}`.trim();
        card.innerHTML = `
          <div class="title">${displayName(item.id)}</div>
          <div class="row"><span>ID</span><span class="val">${item.id}</span></div>
          <div class="row"><span>${item.city}</span><span class="val">${item.lym.toLocaleString('de-DE')}</span></div>
          <div class="row"><span>Black Market</span><span class="val">${item.bm.toLocaleString('de-DE')}</span></div>
          <div class="row"><span>Sold/Tag</span><span class="val">${item.sold ?? 0}</span></div>
          <div class="profit">${profitText} <span class="pill">${item.span}</span></div>
        `;
        cardsEl.appendChild(card);
      }
    }

    function loadResults() {
      return new Promise((resolve, reject) => {
        const s = document.createElement("script");
        s.src = "results.js?v=" + Date.now();
        s.onload = () => {
          allData = window.results || [];
          resolve();
        };
        s.onerror = reject;
        document.body.appendChild(s);
      });
    }

    function renderLastUpdated(text) {
      const parts = text.trim().split(/\s+/);
      const time = parts[0] || "";
      const date = parts[1] || "";
      lastUpdatedEl.innerHTML = `Last updated: <span class="lu-time">${time}</span> <span class="lu-date">${date}</span>`;
    }

    function setLastUpdated(text) {
      renderLastUpdated(text);
      localStorage.setItem("lastUpdatedText", text);
    }

    function showToast(msg) {
      const el = document.getElementById('toast');
      el.textContent = msg;
      el.style.display = 'block';
      el.classList.add('visible');
      setTimeout(() => el.classList.remove('visible'), 4000);
      setTimeout(() => { el.style.display = 'none'; }, 4500);
    }

    function loadStoredTimestamp() {
      const val = localStorage.getItem("lastUpdatedText");
      if (val) renderLastUpdated(val);
    }

    function setCity(city) {
      cityFilter = city;
      cityNameEl.textContent = city === "ALL" ? "All Cities" : city;
      cityCrestEl.src = crestMap[city] || crestMap.ALL;
      setBg(city);
      render();
    }

    async function ensureAuth() {
      const { data } = await supabase.auth.getSession();
      if (data.session) {
        const userResp = await supabase.auth.getUser();
        const user = userResp.data.user;
        if (!user?.email_confirmed_at) {
          await supabase.auth.signOut();
          showToast("Bitte bestÃ¤tige zuerst deine E-Mail.");
          authModal.style.display = "flex";
          app.style.display = "none";
          return false;
        }
        authModal.style.display = "none";
        app.style.display = "block";
        accountEmail.textContent = user?.email || "-";
        return true;
      }
      authModal.style.display = "flex";
      return false;
    }

    async function handleLogin() {
      authError.textContent = "";
      const email = authEmail.value.trim();
      const password = authPassword.value.trim();
      const { error } = await supabase.auth.signInWithPassword({ email, password });
      if (error) authError.textContent = error.message;
      else {
        authModal.style.display = "none";
        app.style.display = "block";
        await loadProfile();
        initApp();
      }
    }

    async function handleRegister() {
      authError.textContent = "";
      const email = regEmail.value.trim();
      const password = regPassword.value.trim();
      const displayName = regName.value.trim();
      if (!displayName || !email || !password) {
        authError.textContent = "Bitte Display Name, E-Mail und Passwort ausfÃ¼llen.";
        return;
      }
      // PrÃ¼fe Display-Name auf Duplikat (wenn Tabelle existiert)
      try {
        const { data: existingName } = await supabase
          .from('profiles')
          .select('id')
          .eq('display_name', displayName)
          .limit(1);
        if (existingName && existingName.length > 0) {
          authError.textContent = "Display Name ist bereits vergeben.";
          return;
        }
      } catch (_) {
        // Tabelle evtl. nicht vorhanden -> ignoriere
      }

      const { data, error } = await supabase.auth.signUp({
        email,
        password,
        options: { data: { display_name: displayName } }
      });
      if (error) {
        const msg = (error.message || "").toLowerCase();
        if (msg.includes("already") || msg.includes("exists") || msg.includes("registered")) {
          authError.textContent = "Account existiert bereits. Bitte einloggen.";
        } else if (error.status === 429) {
          authError.textContent = "Zu viele Versuche. Bitte kurz warten und erneut versuchen.";
        } else {
          authError.textContent = error.message;
        }
        return;
      }

      const userId = data?.user?.id;
      if (userId && displayName) {
        try {
          await supabase.from('profiles').upsert({ id: userId, display_name: displayName });
        } catch (_) { /* ignore */ }
      }
      // Wait until mail has been sent (signUp succeeded)
      confirmModal.style.display = "flex";
      await supabase.auth.signOut();
      authModal.style.display = "flex";
      app.style.display = "none";
    }

    async function handleGoogle() {
      await supabase.auth.signInWithOAuth({
        provider: "google",
        options: { redirectTo: `${window.location.origin}/dashboard.html` }
      });
    }

    function formatDate(dt) {
      const d = dt.getDate().toString().padStart(2, "0");
      const m = (dt.getMonth() + 1).toString().padStart(2, "0");
      const y = dt.getFullYear();
      const h = dt.getHours().toString().padStart(2, "0");
      const min = dt.getMinutes().toString().padStart(2, "0");
      return `${h}:${min}  ${d}.${m}.${y}`;
    }

    async function initApp() {
      loadingOverlay.style.display = "flex";
      await loadResults();
      const stamp = formatDate(new Date());
      setLastUpdated(stamp);
      render();
      loadingOverlay.style.display = "none";
    }

    applyFilterEl.onclick = () => {
      minProfitFilter = Number(minProfitEl.value) || 0;
      render();
    };
    filterSilverEl.onclick = () => { sortBySilver = true; clearSilverEl.style.display = "inline-block"; render(); };
    clearSilverEl.onclick = () => { sortBySilver = false; clearSilverEl.style.display = "none"; render(); };
    citySelectEl.onchange = (e) => setCity(e.target.value);

    btnLogin.onclick = handleLogin;
    btnRegister.onclick = handleRegister;
    btnGoogle.onclick = handleGoogle;
    tabLogin.onclick = () => {
      tabLogin.classList.add("active"); tabRegister.classList.remove("active");
      loginForm.style.display = "block"; registerForm.style.display = "none";
      authError.textContent = "";
    };
    tabRegister.onclick = () => {
      tabRegister.classList.add("active"); tabLogin.classList.remove("active");
      loginForm.style.display = "none"; registerForm.style.display = "block";
      authError.textContent = "";
    };
    accountBtn.onclick = () => {
      document.body.classList.add("panel-open");
      accountPanel.classList.add("open");
    };
    accountClose.onclick = () => {
      document.body.classList.remove("panel-open");
      accountPanel.classList.remove("open");
    };
    resetPw.onclick = async () => {
      const user = (await supabase.auth.getUser()).data.user;
      if (!user?.email) return;
      await supabase.auth.resetPasswordForEmail(user.email);
      showToast(`Reset-Link wurde an ${user.email} gesendet.`);
      document.body.classList.remove("panel-open");
      accountPanel.classList.remove("open");
      await supabase.auth.signOut();
      app.style.display = "none";
      authModal.style.display = "flex";
    };
    logout.onclick = async () => {
      const user = (await supabase.auth.getUser()).data.user;
      if (user?.email) showToast(`Logout: ${user.email}`);
      await supabase.auth.signOut();
      document.body.classList.remove("panel-open");
      accountPanel.classList.remove("open");
      app.style.display = "none";
      authModal.style.display = "flex";
    };
    document.querySelectorAll(".avatar-grid img").forEach(img => {
      img.addEventListener("click", async () => {
        const avatar = img.getAttribute("data-avatar") || img.src;
        const { data } = await supabase.auth.getUser();
        if (!data?.user) return;
        await supabase.auth.updateUser({ data: { avatar } });
        avatarIcon.src = avatar;
        profileAvatar.src = avatar;
      });
    });
    document.addEventListener("click", (e) => {
      if (!accountPanel.contains(e.target) && !accountBtn.contains(e.target)) {
        document.body.classList.remove("panel-open");
        accountPanel.classList.remove("open");
      }
    });
    document.addEventListener("keydown", (e) => {
      if (e.key === "Escape") {
        document.body.classList.remove("panel-open");
        accountPanel.classList.remove("open");
      }
    });
    confirmClose.onclick = () => { confirmModal.style.display = "none"; };

    (async () => {
      const ok = await ensureAuth();
      if (ok) {
        await loadAvatar();
        await initApp();
        setCity("ALL");
      }
    })();
  </script>
</body>
</html>
