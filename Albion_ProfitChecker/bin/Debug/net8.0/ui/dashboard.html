<!DOCTYPE html>
<html lang="de">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Albion Profit Radar - Dashboard</title>
  <base href="/">
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@500;600;700&family=Manrope:wght@400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="styles.css" />
</head>
<body>
  <a href="index.html"><img class="logo-fixed" src="../picture/testo%20ohne%20background.png" alt="Logo" /></a>
  <div class="page">
    <div id="app" style="display:none;">
      <div class="layout">
        <div class="main-col">
          <div class="top-row">
            <div class="hero">
              <div>
                <h1>RomulusKings Market Reader</h1>
                <p>&ge; 30% Profit &bull; Zeiträume 14 Tage &bull; Live-Daten Black Market</p>
              </div>
            </div>
          </div>

          <div class="top-row" style="justify-content: flex-end; margin-top: -12px;">
            <div class="hero-cta">
              <div class="badge" id="refreshBtn" title="Letzte Aktualisierung">
                <span style="font-weight:600;">Letzte Aktualisierung:</span>
                <span id="lastUpdatedTime" style="font-weight:600; margin-left:6px;"></span>
                <span id="lastUpdatedDate" style="font-weight:400; color: var(--muted); margin-left:8px;"></span>
              </div>
              <div style="font-size:12px; color: var(--muted); margin-top:4px; text-align:right;">Deals: <span id="dealCount">0</span></div>
            </div>
          </div>

          <div class="filters">
            <label for="minProfit">Profit ≥</label>
            <input id="minProfit" type="number" step="1" value="0" />
            <span>%</span>
            <button id="applyFilter">Filter anwenden</button>
            <button id="filterSilver" style="margin-left:6px;">Nach Silber filtern</button>
            <button id="clearSilver" style="display:none;">×</button>
          </div>

          <div id="cards" class="grid"></div>
        </div>

        <aside class="aside">
          <div class="city-panel">
            <img id="cityCrestImg" src="../picture/Carleon.png" alt="City Crest" class="city-crest-img" />
            <div class="city-panel-body">
              <div class="city-panel-title">City</div>
              <div class="city-panel-name" id="cityName">Alle Städte</div>
              <select id="citySelect" class="city-select">
                <option value="ALL">Alle Städte</option>
                <option value="Lymhurst">Lymhurst</option>
                <option value="Martlock">Martlock</option>
                <option value="Fort Sterling">Fort Sterling</option>
                <option value="Thetford">Thetford</option>
                <option value="Bridgewatch">Bridgewatch</option>
                <option value="Caerleon">Caerleon</option>
              </select>
            </div>
          </div>
        </aside>
      </div>
    </div>

    <!-- Auth Modal -->
    <div id="auth" class="auth" style="display:flex;">
      <div class="auth-box">
        <h2>Passwort</h2>
        <p id="authMsg">Bitte Passwort eingeben.</p>
        <input type="password" id="authInput" placeholder="Passwort" />
        <button id="authBtn">Weiter</button>
      </div>
    </div>
  </div>

  <script>
    const loadResults = () => new Promise((resolve, reject) => {
      const s = document.createElement('script');
      s.src = `results.js?v=${Date.now()}`;
      s.onload = () => resolve();
      s.onerror = () => reject(new Error('results.js konnte nicht geladen werden'));
      document.head.appendChild(s);
    });

    const app = document.getElementById('app');
    const cards = document.getElementById('cards');
    const minProfitInput = document.getElementById('minProfit');
    const applyFilterBtn = document.getElementById('applyFilter');
    const filterSilverBtn = document.getElementById('filterSilver');
    const clearSilverBtn = document.getElementById('clearSilver');
    const auth = document.getElementById('auth');
    const authInput = document.getElementById('authInput');
    const authBtn = document.getElementById('authBtn');
    const authMsg = document.getElementById('authMsg');
    const refreshBtn = document.getElementById('refreshBtn');
    const lastUpdatedTime = document.getElementById('lastUpdatedTime');
    const lastUpdatedDate = document.getElementById('lastUpdatedDate');
    const dealCountEl = document.getElementById('dealCount');
    const LAST_UPDATED_KEY = 'albion_profit_last_updated';
    const citySelect = document.getElementById('citySelect');
    const cityNameEl = document.getElementById('cityName');
    const cityCrestImg = document.getElementById('cityCrestImg');
    const crestMap = {
      "ALL": "../picture/Carleon.png",
      "Lymhurst": "../picture/Lymhurstwappen.png",
      "Martlock": "../picture/Martlockwappen.png",
      "Fort Sterling": "../picture/Fortsterlingwappen.png",
      "Thetford": "../picture/Thefortwappen.png",
      "Bridgewatch": "../picture/Bridgewatch.png",
      "Caerleon": "../picture/Carleon.png"
    };
    const bgMap = {
      "ALL": 'radial-gradient(circle at 20% 20%, rgba(124, 255, 208, 0.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(117, 193, 255, 0.1), transparent 25%), var(--bg)',
      "Lymhurst": 'radial-gradient(circle at 20% 20%, rgba(124, 255, 208, 0.08), transparent 30%), radial-gradient(circle at 80% 0%, rgba(117, 193, 255, 0.1), transparent 25%), var(--bg)',
      "Fort Sterling": 'radial-gradient(circle at 20% 20%, rgba(255,255,255,0.10), transparent 32%), radial-gradient(circle at 80% 0%, rgba(200,200,200,0.08), transparent 25%), var(--bg)',
      "Caerleon": 'radial-gradient(circle at 20% 20%, rgba(15,15,20,0.55), transparent 32%), radial-gradient(circle at 80% 0%, rgba(0,0,0,0.45), transparent 28%), var(--bg)',
      "Bridgewatch": 'radial-gradient(circle at 20% 20%, rgba(255, 150, 60, 0.16), transparent 32%), radial-gradient(circle at 80% 0%, rgba(255, 110, 20, 0.12), transparent 28%), var(--bg)',
      "Martlock": 'radial-gradient(circle at 20% 20%, rgba(90, 170, 255, 0.18), transparent 32%), radial-gradient(circle at 80% 0%, rgba(60, 130, 230, 0.14), transparent 28%), var(--bg)',
      "Thetford": 'radial-gradient(circle at 20% 20%, rgba(180, 120, 255, 0.16), transparent 32%), radial-gradient(circle at 80% 0%, rgba(140, 80, 220, 0.14), transparent 28%), var(--bg)'
    };

    const nameMap = {
      "MAIN_SWORD": "Broadsword","2H_CLAYMORE": "Claymore","DUAL_SWORD": "Dual Swords","2H_CLEAVER": "Carving Sword",
      "2H_CLEAVER_HELL": "Carving Sword",
      "2H_AXE": "Greataxe","2H_AXE_AVALON": "Realmbreaker",
      "2H_ARCANESTAFF_CRYSTAL": "Astral Staff","2H_ARCANESTAFF_HELL": "Occult Staff","2H_ARCANE_RINGPAIR_AVALON": "Evensong",
      "MAIN_AXE": "Battleaxe","2H_HALBERD": "Halberd","DUAL_AXE": "Bear Paws","2H_SCYTHE": "Infernal Scythe",
      "2H_DUALAXE_KEEPER": "Bear Paws",
      "MAIN_SPEAR": "Spear","2H_GLAIVE": "Glaive","2H_TRIDENT": "Trinity Spear","2H_HARPOON": "Heron Spear",
      "2H_SPEAR": "Pike","2H_SPEAR_HELL": "Trinity Spear","2H_TRIDENT_UNDEAD": "Trinity Spear",
      "2H_BOW": "Bow","2H_WARBOW": "Warbow","2H_LONGBOW": "Longbow","2H_SIEGE_BOW": "Wailing Bow",
      "2H_BOW_AVALON": "Mistpiercer","2H_BOW_CRYSTAL": "Skystrider Bow","2H_BOW_HELL": "Wailing Bow","2H_BOW_KEEPER": "Bow of Badon","2H_LONGBOW_UNDEAD": "Whispering Bow",
      "2H_CROSSBOW": "Crossbow","2H_HEAVYCROSSBOW": "Heavy Crossbow","2H_REPEATINGCROSSBOW": "Light Crossbow","2H_WEAPONIZEDCROSSBOW": "Energy Shaper",
      "2H_CROSSBOWLARGE": "Heavy Crossbow","2H_CROSSBOWLARGE_MORGANA": "Siegebow","2H_CROSSBOW_CANNON_AVALON": "Energy Shaper","2H_REPEATINGCROSSBOW_UNDEAD": "Repeating Crossbow",
      "MAIN_FIRESTAFF": "Fire Staff","2H_FIRESTAFF": "Great Fire Staff","2H_INFERNOSTAFF": "Infernal Staff","2H_WILDFIRESTAFF": "Wildfire Staff",
      "2H_FIRESTAFF_HELL": "Infernal Staff","2H_FIRESTAFF_KEEPER": "Wildfire Staff",
      "MAIN_FROSTSTAFF": "Frost Staff","2H_FROSTSTAFF": "Great Frost Staff","2H_GLACIALSTAFF": "Glacial Staff","2H_HOARFROSTSTAFF": "Hoarfrost Staff","2H_ICEGAUNTLETS": "Icicle Staff",
      "2H_FROSTSTAFF_CRYSTAL": "Arctic Staff","2H_FROSTSTAFF_GLACIAL": "Glacial Staff",
      "MAIN_HOLYSTAFF": "Holy Staff","2H_HOLYSTAFF": "Great Holy Staff","2H_DIVINESTAFF": "Divine Staff","2H_LIFETOUCHSTAFF": "Lifetouch Staff","2H_REDEMPTIONSTAFF": "Redemption Staff",
      "2H_HOLYSTAFF_HELL": "Lifetouch Staff","2H_HOLYSTAFF_KEEPER": "Redemption Staff",
      "MAIN_NATURESTAFF": "Nature Staff","2H_NATURESTAFF": "Great Nature Staff","2H_WILDSTAFF": "Wild Staff","2H_DRUIDSTAFF": "Druidic Staff","2H_IRONROOTSTAFF": "Ironroot Staff",
      "2H_NATURESTAFF_HELL": "Blight Staff","2H_NATURESTAFF_KEEPER": "Druidic Staff",
      "MAIN_CURSEDSTAFF": "Cursed Staff","2H_CURSEDSTAFF": "Great Cursed Staff","2H_DEMONICSTAFF": "Demonic Staff","2H_SHADOWSTAFF": "Shadowcaller",
      "2H_CURSEDSTAFF_MORGANA": "Damnation Staff",
      "MAIN_ARCANESTAFF": "Arcane Staff","2H_ARCANESTAFF": "Great Arcane Staff","2H_ENIGMATICSTAFF": "Enigmatic Staff","2H_OCCULTSTAFF": "Occult Staff","2H_EYESTAFF": "Evensong",
      "2H_OCCULTSTAFF_HELL": "Occult Staff",
      "MAIN_DAGGER": "Dagger","2H_DAGGER": "Dagger Pair","DUAL_DAGGER": "Bloodletter","2H_CLAWPAIR": "Claws","2H_DEATHGIVERS": "Deathgivers",
      "2H_DAGGERPAIR": "Dagger Pair","2H_DAGGERPAIR_CRYSTAL": "Bridled Fury","2H_DAGGER_KATAR_AVALON": "Bloodletter","2H_CLAWPAIR": "Claws","2H_HELLFIRE_HAND": "Hellfire Hands",
      "MAIN_HAMMER": "Hammer","2H_HAMMER": "Great Hammer","2H_POLEHAMMER": "Polehammer","2H_RAMHAMMER": "Grovekeeper",
      "2H_DUALHAMMER_AVALON": "Hand of Justice",
      "2H_QUARTERSTAFF": "Quarterstaff","2H_IRONCLADEDSTAFF": "Ironclad Staff","2H_DOUBLEBLADEDSTAFF": "Double Bladed Staff","2H_COMBATSTAFF": "Black Monk Staff","2H_SOULSTAFF": "Soulscythe",
      "2H_COMBATSTAFF_MORGANA": "Black Monk Stave","2H_SOULSTAFF": "Soulscythe","2H_SCYTHE_CRYSTAL": "Crystal Reaper","2H_SCYTHE_HELL": "Soulscythe","2H_TWINSCYTHE_HELL": "Twin Scythes",
      "2H_FLAIL": "Morning Star","2H_FLAIL_MORGANA": "Soulscythe",
      "OFF_SHIELD": "Shield","OFF_TORCH": "Torch","OFF_BOOK": "Tome","OFF_HORN": "Mistcaller","OFF_TALISMAN": "Sacred Scepter","OFF_CENSER": "Censer",
      "OFF_CENSER_AVALON": "Celestial Censer","OFF_HORN_KEEPER": "Mistcaller","OFF_TALISMAN_AVALON": "Sacred Scepter",
      "HEAD_PLATE_SET1": "Soldier Helmet","HEAD_PLATE_SET2": "Knight Helmet","HEAD_PLATE_SET3": "Guardian Helmet",
      "HEAD_PLATE_AVALON": "Helmet of Valor","HEAD_PLATE_HELL": "Demon Helmet","HEAD_PLATE_FEY": "Duskweaver Helmet","HEAD_PLATE_KEEPER": "Judicator Helmet","HEAD_PLATE_UNDEAD": "Graveguard Helmet",
      "ARMOR_PLATE_SET1": "Soldier Armor","ARMOR_PLATE_SET2": "Knight Armor","ARMOR_PLATE_SET3": "Guardian Armor",
      "ARMOR_PLATE_AVALON": "Armor of Valor","ARMOR_PLATE_HELL": "Demon Armor","ARMOR_PLATE_FEY": "Duskweaver Armor","ARMOR_PLATE_KEEPER": "Judicator Armor","ARMOR_PLATE_UNDEAD": "Graveguard Armor",
      "SHOES_PLATE_SET1": "Soldier Boots","SHOES_PLATE_SET2": "Knight Boots","SHOES_PLATE_SET3": "Guardian Boots",
      "SHOES_PLATE_AVALON": "Boots of Valor","SHOES_PLATE_HELL": "Demon Boots","SHOES_PLATE_FEY": "Duskweaver Boots","SHOES_PLATE_KEEPER": "Judicator Boots","SHOES_PLATE_UNDEAD": "Graveguard Boots",
      "HEAD_LEATHER_SET1": "Mercenary Hood","HEAD_LEATHER_SET2": "Hunter Hood","HEAD_LEATHER_SET3": "Assassin Hood",
      "ARMOR_LEATHER_SET1": "Mercenary Jacket","ARMOR_LEATHER_SET2": "Hunter Jacket","ARMOR_LEATHER_SET3": "Assassin Jacket",
      "SHOES_LEATHER_SET1": "Mercenary Shoes","SHOES_LEATHER_SET2": "Hunter Shoes","SHOES_LEATHER_SET3": "Assassin Shoes",
      "HEAD_CLOTH_SET1": "Scholar Cowl","HEAD_CLOTH_SET2": "Cleric Cowl","HEAD_CLOTH_SET3": "Mage Cowl",
      "ARMOR_CLOTH_SET1": "Scholar Robe","ARMOR_CLOTH_SET2": "Cleric Robe","ARMOR_CLOTH_SET3": "Mage Robe",
      "SHOES_CLOTH_SET1": "Scholar Sandals","SHOES_CLOTH_SET2": "Cleric Sandals","SHOES_CLOTH_SET3": "Mage Sandals",
      "CAPE": "Cape","BAG": "Bag"
    };

    let allData = [];
    let minProfitFilter = 0;
    let sortBySilver = false;
    let cityFilter = 'ALL';
    let authed = false;
    let spinning = false;
    let progressTimer = null;
    const progressEl = document.createElement('span');
    progressEl.style.display = 'none';
    refreshBtn.appendChild(progressEl);

    function render() {
      cards.innerHTML = "";
      const source = allData.length > 0 ? allData : (window.results || []);
      const data = source
        .filter(r => (Number(r.profit ?? 0)) >= minProfitFilter)
        .filter(r => cityFilter === 'ALL' ? true : (r.city || '').toLowerCase() === cityFilter.toLowerCase());
      const sorted = [...data].sort((a, b) => {
        if (sortBySilver) {
          const sa = (a.bm ?? 0) - (a.lym ?? 0);
          const sb = (b.bm ?? 0) - (b.lym ?? 0);
          return sb - sa;
        }
        return (b.profit ?? 0) - (a.profit ?? 0);
      });
      dealCountEl.textContent = sorted.length;
      if (!Array.isArray(data) || data.length === 0) {
        const empty = document.createElement('div');
        empty.style.color = 'var(--muted)';
        empty.style.padding = '12px 4px';
        empty.textContent = 'Keine Ergebnisse geladen.';
        cards.appendChild(empty);
        return;
      }
      sorted.forEach(r => {
        const card = document.createElement('div');
        const silverDiff = (r.bm ?? 0) - (r.lym ?? 0);
        const profitValue = sortBySilver ? silverDiff : (r.profit ?? 0);
        const profitClass = profitValue < 0 ? 'profit negative' : 'profit';
        const match = /^T?(\d+)?_(.+?)(?:@(\d+))?$/i.exec(r.id) || [];
        const tier = match[1];
        const baseCode = (match[2] || r.id).trim().toUpperCase();
        const enchant = match[3] ? parseInt(match[3], 10) : 0;
        const baseLabel = nameMap[baseCode] || baseCode;
        let displayName = baseLabel;
        if (tier) {
          const tierLabel = enchant ? `${tier}.${enchant}` : `${tier}`;
          displayName = `${tierLabel}\u00A0\u00A0${baseLabel}`;
        }
        const tagClass = enchant ? `tag enchant-${enchant}` : '';
        const tagHtml = tagClass ? `<span class="${tagClass}"></span>` : '';
        const borderClass = enchant ? `border-enchant-${enchant}` : '';
        card.className = `card card-box ${borderClass}`.trim();
        card.innerHTML = `
          ${tagHtml}
          <div class="title">${displayName}</div>
          <div class="row"><span>ID</span><span class="val">${r.id}</span></div>
          <div class="row"><span>${r.city || 'City'}</span><span class="val">${r.lym.toLocaleString()}</span></div>
          <div class="row"><span>Black Market</span><span class="val">${r.bm.toLocaleString()}</span></div>
          <div class="row"><span>Sold/Tag</span><span class="val">${(r.sold ?? 0).toLocaleString(undefined, { minimumFractionDigits: 0, maximumFractionDigits: 1 })}</span></div>
          <div class="${profitClass}">
            ${sortBySilver
              ? `Profit: ${profitValue.toLocaleString()}`
              : `Profit: ${profitValue > 0 ? '+' : ''}${profitValue.toFixed(1)}%`}
            <span class="span-tag">${r.span}</span>
          </div>
        `;
        cards.appendChild(card);
      });
    }

    function startApp() {
      loadResults()
        .then(() => {
          allData = window.results || [];
          render();
          loadStoredLastUpdated();
        })
        .catch(() => {
          const empty = document.createElement('div');
          empty.style.color = 'var(--muted)';
          empty.style.padding = '12px 4px';
          empty.textContent = 'results.js konnte nicht geladen werden.';
          cards.appendChild(empty);
        });
    }

    function setSpinning(on) {
      spinning = on;
      refreshBtn.style.opacity = on ? '0.75' : '1';
      refreshBtn.style.cursor = 'default';
      if (!on) {
        progressEl.textContent = '';
        if (progressTimer) {
          clearInterval(progressTimer);
          progressTimer = null;
        }
      }
    }

    async function pollProgress() {
      try {
        const resp = await fetch('/progress');
        if (!resp.ok) return;
        const { total = 0, done = 0 } = await resp.json();
        if (total > 0) {
          const pct = Math.min(100, Math.round((done / total) * 100));
          progressEl.textContent = `${pct}%`;
        }
      } catch {
        // ignore
      }
    }

    refreshBtn.addEventListener('click', () => {
      // bewusst keine Aktion mehr (Frontend getrennt vom Backend)
      return;
    });

    applyFilterBtn.addEventListener('click', () => {
      const val = parseFloat(minProfitInput.value);
      minProfitFilter = isNaN(val) ? 0 : val;
      render();
    });

    filterSilverBtn.addEventListener('click', () => {
      sortBySilver = true;
      clearSilverBtn.style.display = 'inline-flex';
      render();
    });

    clearSilverBtn.addEventListener('click', () => {
      sortBySilver = false;
      clearSilverBtn.style.display = 'none';
      render();
    });

    function setCity(city) {
      cityFilter = city;
      cityNameEl.textContent = cityFilter === 'ALL' ? 'Alle Städte' : cityFilter;
      const crestSrc = crestMap[cityFilter] || crestMap.ALL;
      cityCrestImg.src = crestSrc;
      cityCrestImg.onerror = () => { cityCrestImg.onerror = null; cityCrestImg.src = crestMap.ALL; };
      cityCrestImg.alt = `${cityNameEl.textContent} Crest`;
      const bg = bgMap[cityFilter] || bgMap.ALL;
      document.body.style.background = bg;
    }

    citySelect.addEventListener('change', () => {
      setCity(citySelect.value);
      render();
    });

    function persistLastUpdated(iso) {
      try { localStorage.setItem(LAST_UPDATED_KEY, iso); } catch { /* ignore */ }
      const d = new Date(iso);
      lastUpdatedTime.textContent = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
      lastUpdatedDate.textContent = d.toLocaleDateString();
    }

    function loadStoredLastUpdated() {
      try {
        const stored = localStorage.getItem(LAST_UPDATED_KEY);
        if (stored) {
          const d = new Date(stored);
          lastUpdatedTime.textContent = d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          lastUpdatedDate.textContent = d.toLocaleDateString();
        }
      } catch { /* ignore */ }
    }

    function tryAuth() {
      const val = authInput.value.trim();
      if (val === 'testo') {
        authed = true;
        auth.style.display = 'none';
        app.style.display = 'block';
        startApp();
      } else {
        authMsg.textContent = 'Falsches Passwort.';
        authMsg.style.color = 'var(--danger)';
      }
    }

    authBtn.addEventListener('click', tryAuth);
    authInput.addEventListener('keydown', (e) => { if (e.key === 'Enter') tryAuth(); });

    // Initial crest
    setCity('ALL');
  </script>
</body>
</html>
